language: php

env:
  global:
    - GH_REPO="github.com/${TRAVIS_REPO_SLUG}.git"

matrix:
  fast_finish: true
  include:
    - php: 7.2
    - php: 7.1
    - php: 7.0
    - php: 5.6

branches:
  only:
    - master

before_install:
  - cp $HOME/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini /tmp
  - phpenv config-rm xdebug.ini

install: travis_retry composer update --prefer-dist

jobs:
  include:
    - stage: test
      name: Low dependencies
      install: travis_retry composer update --prefer-dist --prefer-lowest

    - stage: test
      name: Code coverage
      before_install: ~
      script: ./vendor/bin/phpunit
      after_script: travis_retry bash <(curl -s https://codecov.io/bash) -f build/logs/clover.xml

    - stage: code quality
      name: Coding standards
      install: travis_retry wget http://cs.sensiolabs.org/download/php-cs-fixer-v2.phar -q -O php-cs-fixer.phar
      script: php php-cs-fixer.phar fix --dry-run --stop-on-violation -v

    - stage: code quality
      name: Static analysis
      install: travis_retry composer install --prefer-dist
      before_script: wget https://github.com/phpstan/phpstan/releases/download/0.9.2/phpstan.phar -q -O phpstan.phar
      script: vendor/bin/phpstan analyse --level=2 src

    - stage: prepare deploy
      name: Build API docs
      script: sh ./scripts/prepare-docs.sh

    - stage: deploy
      name: Deploy API docs to GitHub pages
      provider: pages
      skip_cleanup: true
      github_token: $GITHUB_TOKEN
      local_dir: build/docs

stages:
  - test
  - code quality
  - name: prepare deploy
    if: branch = master
  - name: deploy
    if: branch = master

notifications:
  slack:
    secure: CMTkQ1GJQ+DVMoiRSPOO0h+eu3f2qmoMCSF2xQ5gqA0TXN6YTWR0CgfMucGFiynnUwswtEO7ZX/ubfMtL9drwD1+L0AZcMZf9T9v/MPHhkoIeJKhnrkl0oO8BcINUNk696172LhY8wVuiXYtztoPJgI8Jlhb1E1ZOaw9Qa3NbobVTKEaDfPjqua4h9/xgUW7r3vQT/0TowtmXypUZ+bGDnEXPIlcQZ8MLZYSlyIFpQSEXb5BRC09PHCmohPsHjsKmx/UcYXxNkodxNk+2cHPd+RpTBvC+yetRXN38UYbKz0JP7rBFC+74W7k2hA3hREBdqhmqUaXX6iqLvzWuCdYKP6X5VCOVxNGPom5xLW9wSsugFusy9VxDw+yMiYDpsD5M4gPNac8erBC1Y/c9jhPmBA47dbIxS6uF0q7jfC/h2iUvK0ZGintvGcQ2H6nMcczyDJ4TI/bhX3tw8dcR2xEmt2rb/rgr450noYB6a4LNNVYvyxB/ttb82PYuRZBcKI4Gjk1GTpHg1flYHrahJfqXxgTnzuXoMqPQ0KUAD4T2dbfbaal+WX6VIZBtwKRq857iUNbaXOrCDBr7CzU9ms91x2IYvXNr+7jBrC0TGa4ImK/iohLrEG9w7x7hzGPoupFsTqaxN33mL0ktu/z0/ESUkuoQ0y7FkWXRZ6JEaPO0j0=
